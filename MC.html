<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EYC Command Center</title>
    <?!= include('mcstyle'); ?>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div class="main-container">
    <header class="agent-header">
        <div class="agent-info">
            <img id="agent-avatar" src="" alt="Agent">
            <div>
                <h1 id="agent-name">LOADING...</h1>
                <p id="agent-id">EYC-XXXX</p>
                <div class="badge" id="agent-title">Greeny</div>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-star gold-icon"></i>
                <span id="total-score">0</span>
                <p>TOTAL SCORE</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-trophy"></i>
                <span id="agent-rank">#0</span>
                <p>RANK</p>
            </div>
        </div>
    </header>

    <section class="progress-section">
        <div class="progress-label">
            <span>MISSION PROGRESS</span>
            <span id="progress-percent">0%</span>
        </div>
        <div class="p-bar-bg">
            <div class="p-bar-fill" id="progress-fill"></div>
        </div>
    </section>

    <nav class="mission-tabs">
        <button class="tab-btn active" onclick="showTab('hybrid')">HYBRID (6)</button>
        <button class="tab-btn" onclick="showTab('hybridx')">HYBRID-X (10)</button>
    </nav>

    <div id="mission-container">
        </div>
</div>

<script>
    // بيانات الأنشطة حسب كود النشاط في الخطة
    const hybridMissions = [
        { name: "Grammar", code: "GS" },
        { name: "Alike", code: "AS" },
        { name: "Seeds", code: "SS" },
        { name: "Vivid", code: "VS" },
        { name: "Label", code: "LS" },
        { name: "Golden Ear", code: "GES" }
    ];

    const hybridXMissions = [
        { name: "GrammarX", code: "GX" },
        { name: "AlikeX", code: "AX" },
        { name: "SeedsX", code: "SX" },
        { name: "VividX", code: "VX" },
        { name: "LabelX", code: "LX" },
        { name: "Golden EarX", code: "GEX" },
        { name: "FigurativeX", code: "FX" },
        { name: "DictationX", code: "DX" },
        { name: "Sing Sang SungX", code: "SSSX" },
        { name: "ElmagazineX", code: "ELX" }
    ];

    // استدعاء بيانات الطالب عند الفتح
    window.onload = function() {
        const userEmail = localStorage.getItem('agentEmail') || "<?!= Session.getActiveUser().getEmail() ?>";
        google.script.run
            .withSuccessHandler(updateUI)
            .getStudentData(userEmail);
        
        showTab('hybrid'); // العرض الافتراضي
    };

    function updateUI(data) {
        if (!data) return;
        const info = data.info;
        
        // توزيع البيانات حسب ترتيب أعمدة الشيت (0-27)
        document.getElementById('agent-name').innerText = info[1]; // Full Name
        document.getElementById('agent-id').innerText = info[6];   // Student Code
        document.getElementById('agent-avatar').src = info[5];     // Image URL
        document.getElementById('total-score').innerText = info[24]; // Total Score
        document.getElementById('agent-title').innerText = info[26]; // Title
        document.getElementById('agent-rank').innerText = "#" + data.rank;
        
        // تحديث شريط التقدم (160 مهمة)
        const progress = info[27]; // Progress Bar %
        document.getElementById('progress-percent').innerText = progress + "%";
        document.getElementById('progress-fill').style.width = progress + "%";
    }

    function showTab(type) {
        const container = document.getElementById('mission-container');
        container.innerHTML = "";
        const missions = (type === 'hybrid') ? hybridMissions : hybridXMissions;

        missions.forEach(m => {
            let card = document.createElement('div');
            card.className = "mission-group-card";
            card.innerHTML = `<h3>${m.name}</h3><div class="mission-numbers" id="grid-${m.code}"></div>`;
            container.appendChild(card);

            const grid = document.getElementById(`grid-${m.code}`);
            for(let i=1; i<=10; i++) {
                let btn = document.createElement('button');
                btn.innerText = i;
                // تنفيذ منطق الربط مع MIF على GitHub
                btn.onclick = () => launchMIF(m.code, i);
                grid.appendChild(btn);
            }
        });
    }

    // وظيفة الربط الاحترافي مع MIF
        function launchMIF(activityCode, missionNum) {
        // 1. تحديد الرابط الأساسي لملفات الجيت هب (تأكد من وضع روابطك هنا)
        const githubBase = "https://raw.githack.com/YOUR_GITHUB_USER/YOUR_REPO/main/assets/MIF/";
        const missionFile = `${activityCode}${missionNum}.html`;
        const fullMissionURL = `${githubBase}${missionFile}`;

        // 2. منطق التوجيه الذكي:
        // سنفحص إذا كان كود النشاط موجوداً ضمن قائمة الـ hybridXMissions
        const isX = hybridXMissions.some(m => m.code === activityCode);
        
        // 3. اختيار الصفحة المناسبة بناءً على نوع النشاط
        const targetPage = isX ? 'HybirdX' : 'Hybird';

        // 4. التوجيه النهائي مع تمرير الرابط
        window.location.href = `?page=${targetPage}&missionURL=${fullMissionURL}`;
    }

</script>

</body>
</html>
