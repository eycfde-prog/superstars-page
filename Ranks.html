<script>
    // 1. ضع هنا رابط الـ CSV الذي نسخته بعد عمل Publish to Web
    // تأكد أن الرابط ينتهي بـ output=csv
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1FrURjUbaWGVvS5p7JPRan7AKLpGDUrij/pub?output=csv';

    // دالة لجلب البيانات من صفحة معينة في الشيت
    async function fetchSheetData(sheetName) {
        try {
            // نضيف اسم الصفحة للرابط (نستخدم gid لو أردت دقة أكثر، لكن هنا سنستخدم اسم الصفحة)
            const response = await fetch(`${SHEET_URL}&sheet=${encodeURIComponent(sheetName)}`);
            const data = await response.text();
            return csvToJson(data);
        } catch (error) {
            console.error("Error loading data: ", error);
        }
    }

    // محول الـ CSV إلى JSON مبسط
    function csvToJson(csv) {
        const lines = csv.split('\n');
        const result = [];
        const headers = lines[0].split(',');

        for (let i = 1; i < lines.length; i++) {
            if (!lines[i]) continue;
            const obj = {};
            const currentline = lines[i].split(',');

            headers.forEach((header, index) => {
                obj[header.trim()] = currentline[index]?.trim();
            });
            result.push(obj);
        }
        return result;
    }

    // دالة عرض البيانات
    async function loadAllRanks() {
        // تحميل بيانات الماستر
        const masterData = await fetchSheetData('Master Sheet');
        const masterBody = document.getElementById('master-body');
        masterBody.innerHTML = masterData.map(st => `
            <tr>
                <td class="rank-number">#${st['الترتيب'] || ''}</td>
                <td>${st['اسم الطالب'] || ''}</td>
                <td>${st['اللقب'] || ''}</td>
                <td>${st['عدد التوكينز'] || '0'}</td>
                <td class="stars-count">${st['عدد النجوم'] || '0'}</td>
            </tr>
        `).join('');

        // تحميل بيانات إكسبوكس
        const xboxData = await fetchSheetData('XBox Rank');
        const xboxBody = document.getElementById('xbox-body');
        xboxBody.innerHTML = xboxData.map(st => {
            let badges = '';
            for(let i=0; i<10; i++) badges += `<div class="logo-placeholder"></div>`;
            return `
                <tr>
                    <td class="rank-number">#${st['الترتيب'] || ''}</td>
                    <td>${st['اسم الطالب'] || ''}</td>
                    <td>${st['عدد التوكينز'] || '0'}</td>
                    <td><div class="logo-grid xbox-logos">${badges}</div></td>
                </tr>
            `;
        }).join('');

        // تحميل بيانات السيزون
        const seasonData = await fetchSheetData('Season Rank');
        const seasonBody = document.getElementById('season-body');
        seasonBody.innerHTML = seasonData.map(st => {
            let badges = '';
            for(let i=0; i<5; i++) badges += `<div class="logo-placeholder"></div>`;
            return `
                <tr>
                    <td class="rank-number">#${st['الترتيب'] || ''}</td>
                    <td>${st['اسم الطالب'] || ''}</td>
                    <td>${st['عدد التوكينز'] || '0'}</td>
                    <td><div class="logo-grid season-logos">${badges}</div></td>
                </tr>
            `;
        }).join('');
    }

    // التنقل بين التبويبات
    function showRank(id) {
        document.querySelectorAll('.rank-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // تشغيل الجلب عند فتح الصفحة
    window.onload = loadAllRanks;
</script>
