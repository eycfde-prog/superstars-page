<script>
    // --- إعدادات المحرك الرئيسية ---
    const urlParams = new URLSearchParams(window.location.search);
    const fullCode = (urlParams.get('act') || 'AS1').toUpperCase(); // الكود كامل مثل AS1 أو AX1A
    const mNumParam = urlParams.get('m') || '1'; // رقم المهمة 1-10
    const actName = urlParams.get('name') || 'Activity'; 
    let currentLevel = 'A';

    // 1. استخراج نوع النشاط (AS, GES, AX...)
    // نقوم بحذف الأرقام وحرف المستوى من الكود للحصول على اسم ملف الـ JS
    // مثال: AX1A تصبح AX | AS1 تصبح AS
    const actType = fullCode.replace(/[0-9]/g, '').replace(/[ABC]$/, ''); 

    // 2. استخراج رقم المهمة من الكود (لإرساله لملف التصحيح)
    // نأخذ الأرقام فقط من الكود (مثل AS10 -> 10)
    const missionNumber = fullCode.match(/\d+/)[0];

    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwNrfn_k9WIt2uQo4hxUw_0JU6pKnwP1lvyYXQnHhHPv_zpfAL5602QSxC_VGu4V7mflA/exec";
    const isElite = fullCode.includes('X');

    // تحديث الواجهة
    document.getElementById('actNameDisplay').innerText = actName;
    document.getElementById('actCodeDisplay').innerText = fullCode;
    document.getElementById('missionNum').innerText = 'M ' + missionNumber;

    // تحميل ملف التصحيح ديناميكياً
    function loadCheckerScript() {
        const script = document.createElement('script');
        script.src = `assets/CC/${actType}.js`;
        script.onload = () => console.log(`Checker ${actType}.js Loaded`);
        document.getElementById('checkerScriptContainer').appendChild(script);
    }
    loadCheckerScript();

    // تهيئة المهمة (فتح ملف الـ HTML الصحيح)
    async function initMission(level = 'A') {
        currentLevel = level;
        const iframe = document.getElementById('mainIframe');
        const loader = document.getElementById('loadingElement');
        loader.style.display = 'block';

        // تحديد اسم الملف بناءً على القواعد التي وضعتها
        // العادية: AS1.html | الـ Elite: AX1A.html
        let fileName;
        if (isElite) {
            fileName = `${actType}${missionNumber}${level}.html`;
        } else {
            fileName = `${actType}${missionNumber}.html`;
        }

        iframe.src = `assets/MIF/${fileName}`;
    }

    // معالجة الإرسال
    async function processSubmission() {
        const submitBtn = document.getElementById('submitBtn');
        const saved = JSON.parse(localStorage.getItem('eyc_agent_data') || '{}');
        const iframe = document.getElementById('mainIframe');

        try {
            submitBtn.disabled = true;
            submitBtn.innerText = "CHECKING...";

            // جلب الإجابات من الـ Iframe
            const studentAnswers = iframe.contentWindow.getStudentAnswers();
            if (!studentAnswers) {
                alert("Please fill all fields!");
                submitBtn.disabled = false;
                submitBtn.innerText = "SUBMIT";
                return;
            }

            // التصحيح باستخدام ملف الـ CC
            // نستخدم مصفوفة الإجابات المحولة لنص (كما يتوقع ملف AS.js)
            const answerString = studentAnswers.join(", ");
            
            // استدعاء دالة التقييم من ملف AS.js
            const result = evaluateMission(missionNumber, answerString);

            prizeValue = result.points;

            // إرسال للشييت
            const payload = {
                email: saved.email,
                activity: fullCode,
                mission: missionNumber,
                level: isElite ? currentLevel : 'A',
                answer: answerString,
                points: result.points,
                isCorrect: result.isCorrect
            };

            await fetch(SCRIPT_URL, { method: "POST", mode: 'no-cors', body: JSON.stringify(payload) });

            // تلوين النتائج في صفحة النشاط
            if (iframe.contentWindow.highlightResults) {
                // نحتاج لتحويل نتيجة evaluateMission لمصفوفة true/false للنشاط
                // ملاحظة: هذا يعتمد على منطق AS.js الخاص بك
                // iframe.contentWindow.highlightResults(someResultArray);
            }

            document.getElementById('rewardContainer').style.display = 'block';
            animate();

        } catch (e) {
            console.error(e);
            alert("Connection Error!");
            submitBtn.disabled = false;
        }
    }
    window.onload = () => { initMission(); };
</script>
