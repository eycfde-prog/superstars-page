/**
 * كود سحب الإيميلات المطور لدعم Golden Ear X و Dictation
 * يا مستر، هذا الكود سيقوم بتجهيز الشيت ليدعم النشاطين معاً
 */
function syncEmailsFromMainSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let lkeySheet = ss.getSheetByName("Lkey");
  if (!lkeySheet) {
    lkeySheet = ss.insertSheet("Lkey");
  }
  
  // 1. إعداد العناوين في الصف الأول (Email | Golden Ear X | Dictation)
  const headers = [["Email", "Golden Ear X", "Dictation"]];
  const currentHeader = lkeySheet.getRange(1, 1, 1, 3).getValues();
  
  if (JSON.stringify(currentHeader[0]) !== JSON.stringify(headers[0])) {
    lkeySheet.getRange(1, 1, 1, 3).setValues(headers);
    lkeySheet.getRange(1, 1, 1, 3).setFontWeight("bold").setBackground("#f3f3f3"); 
  }
  
  const mainSheetId = "1jqnXozGxe1vAlnSWo1dqJxHz1pjZGQIs2SuKwcYjbJw";
  const mainSheetName = "Form Responses 1";
  
  try {
    const mainFile = SpreadsheetApp.openById(mainSheetId);
    const sourceSheet = mainFile.getSheetByName(mainSheetName);
    
    if (!sourceSheet) return;

    const lastRowSource = sourceSheet.getLastRow();
    if (lastRowSource < 2) return;
    
    const sourceEmails = sourceSheet.getRange("B2:B" + lastRowSource).getValues();
    const lkeyData = lkeySheet.getDataRange().getValues();
    const existingEmails = lkeyData.map(row => row[0] ? row[0].toString().toLowerCase().trim() : "");

    let addedCount = 0;

    // 2. إضافة الإيميلات الجديدة مع ضبط الحالة "No" للنشاطين
    sourceEmails.forEach(row => {
      const email = row[0] ? row[0].toString().toLowerCase().trim() : "";
      
      if (email && email.includes("@") && !existingEmails.includes(email)) {
        // إضافة الإيميل (A) وحالة GEX (B) وحالة Dictation (C)
        lkeySheet.appendRow([email, "No", "No"]);
        existingEmails.push(email);
        addedCount++;
      }
    });

    console.log("تم تحديث الشيت بنجاح. تمت إضافة: " + addedCount);
    
  } catch (e) {
    console.error("خطأ في الاتصال: " + e.message);
  }
}

/**
 * وظيفة استقبال الطلبات المطورة
 * الجديد هنا باراميتر activity: (gex أو dict)
 */
function doGet(e) {
  const email = e.parameter.email;
  const action = e.parameter.action; 
  const activity = e.parameter.activity || "gex"; // القيمة الافتراضية gex
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("Lkey");
  
  if (!sheet) return createJsonResponse({ status: "error", msg: "Lkey sheet missing" });

  const data = sheet.getDataRange().getValues();
  let userRow = -1;

  for (let i = 0; i < data.length; i++) {
    if (data[i][0] && data[i][0].toString().trim().toLowerCase() === email.toString().trim().toLowerCase()) {
      userRow = i + 1;
      break;
    }
  }

  // تحديد العمود بناءً على النشاط
  // عمود B (رقم 2) للـ GEX
  // عمود C (رقم 3) للـ Dictation
  const colIndex = (activity === "dict") ? 3 : 2;

  if (action === "check") {
    if (userRow === -1) return createJsonResponse({ status: "not_registered" });
    const status = sheet.getRange(userRow, colIndex).getValue(); 
    return createJsonResponse({ status: status === "Yes" ? "already_listened" : "authorized" });
  }

  if (action === "mark_listened" && userRow !== -1) {
    sheet.getRange(userRow, colIndex).setValue("Yes");
    return createJsonResponse({ status: "success" });
  }

  return createJsonResponse({ status: "invalid_request" });
}

function createJsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
