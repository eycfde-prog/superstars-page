<script>
    const urlParams = new URLSearchParams(window.location.search);
    const taskNum = urlParams.get('task') || "1";
    const storageKey = `DX_Task_${taskNum}_Played`;

    function initDictX() {
        document.getElementById('task-title').innerText = `DICTATION-X: MISSION ${taskNum.padStart(2, '0')}`;
        
        const slowA = document.getElementById('slowAudio');
        const normalA = document.getElementById('normalAudio');
        const audioPath = `assets/dictationxaudio/DX${taskNum}.wav`;
        
        document.getElementById('slowSource').src = audioPath;
        document.getElementById('normalSource').src = audioPath;
        
        slowA.load();
        normalA.load();
        
        slowA.playbackRate = 0.7; 
        normalA.playbackRate = 1.0;

        // التحقق مما إذا كان الطالب قد سمع المقطع سابقاً (حتى بعد الريفرش)
        if (localStorage.getItem(storageKey)) {
            lockAudio(slowA);
            lockAudio(normalA);
        }
    }

    function disableAudio(el) {
        // بمجرد البدء، نمنع التوقف أو التلاعب بشريط الوقت
        el.onplay = null; // نلغي الحدث لعدم التكرار
        localStorage.setItem(storageKey, "true"); // تسجيل المحاولة فوراً

        // منع الطالب من تقديم أو تأخير الصوت
        el.ontimeupdate = function() {
            if (!el.seeking) return;
            el.currentTime = el.played.end(0);
        };

        // عند الانتهاء، يتم قفل المشغل تماماً
        el.onended = function() {
            lockAudio(el);
        };
    }

    function lockAudio(el) {
        el.controls = false;
        el.pause();
        el.style.opacity = "0.2";
        el.style.pointerEvents = "none";
        if (!el.parentElement.querySelector('.expired-msg')) {
            el.insertAdjacentHTML('afterend', '<p class="expired-msg" style="color:#ff003c; font-family:Orbitron; font-size:10px; margin-top:10px;">MISSION USED - ACCESS DENIED</p>');
        }
    }

    // معاينة الصور
    function preview(input, imgId) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById(imgId);
                img.src = e.target.result;
                img.style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    }

    window.addEventListener('message', function(event) {
        if (event.data.type === 'REQUEST_DICTATIONX_DATA') {
            const files = [
                document.getElementById('p1').src,
                document.getElementById('p2').src,
                document.getElementById('p3').src
            ].filter(src => src.startsWith("data:image"));

            window.parent.postMessage({ 
                type: 'SUBMIT_X', 
                activityCode: 'DX',
                answers: files, // الـ Base64 للصور ليتم رفعها للدرايف
                missionNum: taskNum 
            }, '*');
        }
    });

    window.onload = initDictX;
</script>
