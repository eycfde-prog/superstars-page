<script>
    // روابط ملفات الـ CSV المستخرجة من Google Sheets
    // ملاحظة: يجب أن تقوم بعمل Publish لكل شيت بشكل منفصل أو استخراج الرابط العام
    const SPREADSHEET_ID = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSyhJZX8I6ORcAAeVHbxP7e878guVSBQlwGwpIeTXET5kSuPoZ3KFnut_nu5O-_7_TAE33khAwC4OMi/pubhtml'; // ضع هنا ID الملف من الرابط
    
    // روابط الصفحات الفرعية بتنسيق CSV
    const MASTER_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=Master%20Sheet`;
    const XBOX_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=XBox%20Rank`;
    const SEASON_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=Season%20Rank`;

    function showRank(id) {
        document.querySelectorAll('.rank-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(event) event.currentTarget.classList.add('active');
    }

    // دالة لتحويل CSV إلى Array
    function csvToArray(str, delimiter = ",") {
        const rows = str.slice(str.indexOf("\n") + 1).split("\n");
        return rows.map(row => {
            const values = row.split(delimiter);
            return values.map(v => v.replace(/"/g, ''));
        });
    }

    async function loadData() {
        try {
            // 1. جلب بيانات Master Sheet
            const masterRes = await fetch(MASTER_URL);
            const masterText = await masterRes.text();
            const masterData = csvToArray(masterText);
            
            const masterBody = document.getElementById('master-body');
            masterBody.innerHTML = '';
            masterData.forEach(row => {
                if(row[0]) { // التأكد من وجود اسم
                    masterBody.innerHTML += `
                        <tr>
                            <td class="rank-number">#${row[4]}</td> <td>${row[0]}</td> <td>${row[5]}</td> <td>${row[2]}</td> <td class="stars-count">${row[3]}</td> </tr>`;
                }
            });

            // 2. جلب بيانات Xbox
            const xboxRes = await fetch(XBOX_URL);
            const xboxText = await xboxRes.text();
            const xboxData = csvToArray(xboxText);
            
            const xboxBody = document.getElementById('xbox-body');
            xboxBody.innerHTML = '';
            xboxData.forEach(row => {
                if(row[0]) {
                    let badges = '';
                    for(let i=0; i<10; i++) badges += `<div class="logo-placeholder"></div>`;
                    xboxBody.innerHTML += `
                        <tr>
                            <td class="rank-number">#${row[3]}</td> <td>${row[0]}</td> <td>${row[2]}</td> <td><div class="logo-grid xbox-logos">${badges}</div></td>
                        </tr>`;
                }
            });

            // 3. جلب بيانات Season
            const seasonRes = await fetch(SEASON_URL);
            const seasonText = await seasonRes.text();
            const seasonData = csvToArray(seasonText);
            
            const seasonBody = document.getElementById('season-body');
            seasonBody.innerHTML = '';
            seasonData.forEach(row => {
                if(row[0]) {
                    let badges = '';
                    for(let i=0; i<5; i++) badges += `<div class="logo-placeholder"></div>`;
                    seasonBody.innerHTML += `
                        <tr>
                            <td class="rank-number">#${row[3]}</td> <td>${row[0]}</td> <td>${row[2]}</td> <td><div class="logo-grid season-logos">${badges}</div></td>
                        </tr>`;
                }
            });

        } catch (error) {
            console.error("Error loading data:", error);
        }
    }

    // تشغيل الدالة عند تحميل الصفحة
    window.onload = loadData;
</script>
