<div class="max-w-xl mx-auto mt-4">
    <button onclick="openAvatarCreator()" class="w-full py-4 border-2 border-dashed border-yellow-500/50 text-yellow-500 orbitron font-bold rounded-2xl hover:bg-yellow-500/10 transition-all flex items-center justify-center gap-3">
        <i class="fas fa-user-astronaut"></i> DESIGN YOUR AVATAR (STORY MODE)
    </button>
</div>

<div id="avatarModal" class="modal flex-col">
    <div class="glass-card p-8 w-full max-w-lg relative overflow-hidden">
        <div id="stepProgress" class="h-1 bg-yellow-500 absolute top-0 left-0 transition-all" style="width: 15%"></div>
        
        <div class="flex justify-between items-center mb-8">
            <h3 id="stepTitle" class="orbitron text-yellow-500 text-lg font-black">STEP 01: SELECT GENDER</h3>
            <span class="text-[10px] text-gray-500" id="stepCounter">1 / 6</span>
        </div>

        <div id="stepContent" class="min-h-[300px] flex flex-col justify-center">
            </div>

        <div class="mt-8 flex gap-4">
            <button id="prevStep" onclick="changeStep(-1)" class="flex-1 py-3 bg-white/5 rounded-xl orbitron text-xs hidden">BACK</button>
            <button id="nextStep" onclick="changeStep(1)" class="flex-[2] py-3 bg-yellow-500 text-black orbitron font-black rounded-xl">NEXT PROTOCOL</button>
        </div>
    </div>
</div>

<script>
    // بيانات صانع الشخصيات
    let currentStep = 1;
    let avatarData = { gender: '', skin: '', eyes: '', hairLength: '', hairColor: '', faceStyle: '' };
    
    const steps = {
        1: { title: "SELECT GENDER", type: "gender" },
        2: { title: "SKIN COMPLEXION", type: "skin" },
        3: { title: "EYE AUGMENTATION", type: "eyes" },
        4: { title: "HAIR STRUCTURE", type: "hairLength" },
        5: { title: "CHROME COLOR", type: "hairColor" },
        6: { title: "FACE TOPOLOGY", type: "faceStyle" }
    };

    function openAvatarCreator() {
        document.getElementById('avatarModal').style.display = 'flex';
        renderStep();
    }

    function renderStep() {
        const content = document.getElementById('stepContent');
        const title = document.getElementById('stepTitle');
        const counter = document.getElementById('stepCounter');
        const progress = document.getElementById('stepProgress');
        
        title.innerText = `STEP 0${currentStep}: ${steps[currentStep].title}`;
        counter.innerText = `${currentStep} / 6`;
        progress.style.width = `${(currentStep / 6) * 100}%`;
        content.innerHTML = '';

        document.getElementById('prevStep').style.display = currentStep === 1 ? 'none' : 'block';
        document.getElementById('nextStep').innerText = currentStep === 6 ? 'FINALIZE AGENT' : 'NEXT PROTOCOL';

        const grid = document.createElement('div');
        grid.className = "grid grid-cols-2 gap-4";

        if(currentStep === 1) { // النوع
            grid.innerHTML = `
                <div onclick="setAvatarProp('gender', 'boy')" class="p-6 border-2 ${avatarData.gender === 'boy' ? 'border-yellow-500 bg-yellow-500/10' : 'border-white/10'} rounded-2xl text-center cursor-pointer hover:border-yellow-500/50">
                    <i class="fas fa-mars text-4xl mb-2 text-blue-400"></i><p class="orbitron text-xs">BOY</p>
                </div>
                <div onclick="setAvatarProp('gender', 'girl')" class="p-6 border-2 ${avatarData.gender === 'girl' ? 'border-yellow-500 bg-yellow-500/10' : 'border-white/10'} rounded-2xl text-center cursor-pointer hover:border-yellow-500/50">
                    <i class="fas fa-venus text-4xl mb-2 text-pink-400"></i><p class="orbitron text-xs">GIRL</p>
                </div>`;
        } else if(currentStep === 2) { // لون البشرة
            grid.className = "flex justify-between gap-2";
            const colors = ['#4e342e', '#8d6e63', '#d7ccc8', '#ffccbc', '#fff9c4'];
            colors.forEach(c => {
                grid.innerHTML += `<div onclick="setAvatarProp('skin', '${c}')" style="background:${c}" class="w-12 h-12 rounded-full cursor-pointer border-2 ${avatarData.skin === c ? 'border-white' : 'border-transparent'}"></div>`;
            });
        } else {
            // منطق الاختيارات المتغيرة (5 للبنات و3 للولاد)
            const count = avatarData.gender === 'girl' ? 5 : 3;
            grid.className = "grid grid-cols-3 gap-3";
            for(let i=1; i<=count; i++) {
                grid.innerHTML += `
                    <div onclick="setAvatarProp('${steps[currentStep].type}', ${i})" class="p-4 border border-white/10 rounded-xl text-center cursor-pointer hover:bg-white/5">
                        <i class="fas fa-microchip text-yellow-500/50 mb-2"></i>
                        <p class="text-[8px] orbitron">OPT-0${i}</p>
                    </div>`;
            }
        }
        content.appendChild(grid);
    }

    function setAvatarProp(prop, value) {
        avatarData[prop] = value;
        // تشغيل صوت خفيف عند الاختيار
        new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3').play();
        renderStep();
    }

    function changeStep(dir) {
        if(dir === 1 && !avatarData[steps[currentStep].type]) {
            alert("Please select an option to proceed.");
            return;
        }
        currentStep += dir;
        if(currentStep > 6) finalizeAvatar();
        else renderStep();
    }

    function finalizeAvatar() {
        // هنا نقوم "بتوليد" الصورة (تخيلياً في هذا الكود أو ربطها بـ Canvas)
        alert("Avatar Sync Complete! Identity generated.");
        document.getElementById('avatarModal').style.display = 'none';
        document.getElementById('fileName').innerText = "AVATAR_GENERATED.PNG";
        document.getElementById('uploadIcon').className = "fas fa-user-check text-yellow-500 mb-2";
        // يمكن حفظ الاختيارات في Hidden Input ليرسلها الفورم للسيرفر
    }
</script>
