<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EYC - Hybrid Intelligence Area</title>
    <?!= include('mcstyle'); ?> 
    <style>
        :root { --gold: #ffcc00; }
        body { background: #020205; color: white; margin: 0; overflow: hidden; }
        .main-container { display: flex; flex-direction: column; height: 100vh; }
        .mission-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 25px; border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            background: rgba(255, 255, 255, 0.02);
        }
        #mission-frame { flex-grow: 1; width: 100%; border: none; background: transparent; }
        .prev-btn {
            background: transparent; border: 1px solid var(--gold); color: var(--gold);
            padding: 8px 15px; border-radius: 50px; cursor: pointer; font-family: 'Cairo';
        }
        #status-update {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 255, 0, 0.2); padding: 10px 20px; border-radius: 20px;
            border: 1px solid #0f0; z-index: 100; font-family: 'Courier New';
        }
    </style>
</head>
<body>

<div class="main-container">
    <div class="mission-header">
        <button onclick="window.location.href='?page=MC'" class="prev-btn">◀ العودة لمركز القيادة</button>
        <h2 id="mission-title">LOADING MISSION...</h2>
        <div id="agent-display" style="color: var(--gold); font-family: 'Orbitron'; font-size: 0.9rem;">AGENT: ...</div>
    </div>

    <iframe id="mission-frame" src="" allowtransparency="true"></iframe>

    <div id="status-update" style="display: none;">
        <i class="fas fa-sync fa-spin"></i> SYNCING WITH CC ENGINE...
    </div>
</div>

<script>
    // روابط الجيت هب الأساسية
    const GITHUB_MIF_URL = "https://your-user-name.github.io/your-repo/assets/MIF/";
    const GITHUB_CC_URL = "https://your-user-name.github.io/your-repo/assets/CC/";

    let currentActivityCode = ""; // كود النشاط (مثل SS)
    let currentTaskNum = "";

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const missionURL = urlParams.get('missionURL');
        
        if (missionURL) {
            // استخراج كود النشاط والرقم من الرابط (مثلاً SS4.html)
            const fileName = missionURL.split('/').pop().replace('.html', '');
            currentActivityCode = fileName.replace(/[0-9]/g, ''); // SS
            currentTaskNum = fileName.replace(/\D/g, '');       // 4

            const agentName = localStorage.getItem('agentName') || "Agent";
            document.getElementById('agent-display').innerText = "AGENT: " + agentName;
            document.getElementById('mission-title').innerText = `${currentActivityCode} - TASK #${currentTaskNum}`;
            
            // تحميل ملف الـ MIF في الإيفرايم
            document.getElementById('mission-frame').src = missionURL;
        } else {
            alert("Mission Identity Error!");
            window.location.href = '?page=MC';
        }
    };

    // الاستماع لملف الـ MIF (عندما يضغط الطالب Submit داخل الإيفرايم)
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'SUBMIT_MISSION') {
            processCorrection(event.data.answers);
        }
    });

    function processCorrection(studentAnswers) {
        document.getElementById('status-update').style.display = 'block';

        // 1. استدعاء ملف الـ CC الخاص بالنشاط (مثلاً SS.js)
        const ccScriptURL = `${GITHUB_CC_URL}${currentActivityCode}.js`;
        
        // تحميل سكريبت التصحيح ديناميكياً
        const script = document.createElement('script');
        script.src = ccScriptURL;
        script.onload = function() {
            // نفترض أن كل ملف CC يحتوي على دالة اسمها gradeMission
            // هذه الدالة موجودة في ملفات الـ JS في مجلد CC
            const finalScore = gradeMission(studentAnswers); 
            
            // 2. إرسال التقرير النهائي للباك إند
            const finalReport = {
                email: localStorage.getItem('agentEmail'),
                activityCode: currentActivityCode,
                missionNum: currentTaskNum,
                score: finalScore
            };
            
            sendToBackEnd(finalReport);
        };
        document.head.appendChild(script);
    }

    function sendToBackEnd(report) {
        google.script.run
            .withSuccessHandler(function() {
                alert("Mission Accomplished! Score: " + report.score);
                window.location.href = '?page=MC';
            })
            .submitMissionReport(report); 
    }
</script>
</body>
</html>
