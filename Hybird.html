<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EYC - Hybrid Intelligence Area</title>
    <?!= include('mcstyle'); ?> 
    <style>
        :root { --gold: #ffcc00; }
        body { background: #020205; color: white; margin: 0; overflow: hidden; }
        
        .main-container { display: flex; flex-direction: column; height: 100vh; }
        
        .mission-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 25px; border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            background: rgba(255, 255, 255, 0.02);
        }

        /* الإطار الذكي - قلب المهمة */
        #mission-frame { 
            flex-grow: 1; width: 100%; border: none; 
            background: transparent; transition: 0.5s;
        }

        .prev-btn {
            background: transparent; border: 1px solid var(--gold); color: var(--gold);
            padding: 8px 15px; border-radius: 50px; cursor: pointer; font-family: 'Cairo';
            transition: 0.3s;
        }
        .prev-btn:hover { background: var(--gold); color: black; }

        #status-update {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 255, 0, 0.2); padding: 10px 20px; border-radius: 20px;
            border: 1px solid #0f0; z-index: 100;
        }
    </style>
</head>
<body>

<div class="main-container">
    <div class="mission-header">
        <button onclick="window.location.href='?page=MC'" class="prev-btn">◀ العودة لمركز القيادة</button>
        <h2 id="mission-title" style="font-family: 'Cinzel'; font-size: 1.2rem;">LOADING MISSION...</h2>
        <div id="agent-display" style="color: var(--gold); font-family: 'Orbitron'; font-size: 0.9rem;">AGENT: ...</div>
    </div>

    <iframe id="mission-frame" src="" allowtransparency="true"></iframe>

    <div id="status-update" style="display: none;">
        <i class="fas fa-sync fa-spin"></i> TRANSMITTING DATA TO EYC BACKEND...
    </div>
</div>

<script>
    // رابط الجيت هب الأساسي (Assets Path)
    const GITHUB_ASSETS_URL = "https://your-user-name.github.io/your-repo/assets/MIF/";

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // استلام اسم النشاط ورقم المهمة من الرابط (مثلاً: activity=Alike&taskNum=4)
        const activityName = urlParams.get('activity'); 
        const taskNum = urlParams.get('taskNum') || "1";
        
        // استرجاع اسم العميل
        const agentName = localStorage.getItem('agentName') || "Unknown Agent";
        document.getElementById('agent-display').innerText = "AGENT: " + agentName;

        if (activityName) {
            // بناء رابط الملف: Assets/MIF/Alike.html
            // مع إضافة رقم المهمة كـ Hash (#) أو Parameter ليفهمه ملف الـ HTML المستهدف
            const finalMifURL = `${GITHUB_ASSETS_URL}${activityName}.html?task=${taskNum}`;
            
            const iframe = document.getElementById('mission-frame');
            iframe.src = finalMifURL;

            document.getElementById('mission-title').innerText = `${activityName} - TASK #${taskNum}`;
        } else {
            alert("فشل في تحديد المهمة يا مستر عز! ⚠️");
            window.location.href = '?page=MC';
        }
    };

    // الاستماع لنتائج التصحيح القادمة من داخل الإيفرايم
    window.addEventListener('message', function(event) {
        // التأكد أن الرسالة تحتوي على نتائج (Score, Answers, etc.)
        if (event.data && event.data.type === 'SUBMIT_MISSION') {
            sendToBackEnd(event.data);
        }
    });

    function sendToBackEnd(report) {
        document.getElementById('status-update').style.display = 'block';
        
        // إرسال التقرير لـ Google Apps Script (Back End)
        google.script.run
            .withSuccessHandler(function(res) {
                document.getElementById('status-update').style.display = 'none';
                alert("تمت المهمة بنجاح! تحديث التوكنز جاري... ✨");
                window.location.href = '?page=MC';
            })
            .submitMissionReport(report); 
    }
</script>

</body>
</html>
