import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, getDoc, setDoc, updateDoc } from 'firebase/firestore';

// Configuration placeholder - environment will provide these
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'superstars-dictation';

export default function App() {
  const [user, setUser] = useState(null);
  const [studentName, setStudentName] = useState('');
  const [isRegistered, setIsRegistered] = useState(false);
  const [stats, setStats] = useState({ slowHeard: false, normalHeard: false });
  const [loading, setLoading] = useState(true);
  const [message, setMessage] = useState('');

  const slowAudioRef = useRef(null);
  const normalAudioRef = useRef(null);

  // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø³Ø§Ø± Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± ÙƒØ§Ù…Ù„
  const slowAudioUrl = "D%20X%201%20S.wav"; 
  const normalAudioUrl = "D%20X%201%20N.wav";

  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth error", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  const handleLogin = async () => {
    if (!studentName.trim() || !user) return;
    setLoading(true);
    
    const studentId = studentName.toLowerCase().trim().replace(/\s+/g, '_');
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', studentId);
    
    try {
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        setStats(docSnap.data());
      } else {
        const initialData = { 
          slowHeard: false, 
          normalHeard: false, 
          lastActive: new Date().toISOString(),
          studentName: studentName.trim()
        };
        await setDoc(docRef, initialData);
        setStats(initialData);
      }
      setIsRegistered(true);
    } catch (err) {
      console.error("Firestore Error:", err);
      setMessage("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©.");
    }
    setLoading(false);
  };

  const playAudio = async (type) => {
    if (!user || !isRegistered) return;
    
    const isSlow = type === 'slow';
    const audio = isSlow ? slowAudioRef.current : normalAudioRef.current;
    const isHeard = isSlow ? stats.slowHeard : stats.normalHeard;

    if (isHeard) {
      setMessage("Ø¹ÙÙˆØ§Ù‹ ÙŠØ§ Ø¨Ø·Ù„ØŒ Ù„Ù‚Ø¯ Ø§Ø³ØªÙ…Ø¹Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø¨Ø§Ù„ÙØ¹Ù„!");
      return;
    }

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø®Ø·Ø£
    try {
      const studentId = studentName.toLowerCase().trim().replace(/\s+/g, '_');
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', studentId);
      const updateData = isSlow ? { slowHeard: true } : { normalHeard: true };
      
      await updateDoc(docRef, updateData);
      setStats(prev => ({ ...prev, ...updateData }));
      
      // Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù…Ù„Ù Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„
      audio.load();
      const playPromise = audio.play();

      if (playPromise !== undefined) {
        playPromise.catch(error => {
          console.error("Playback failed:", error);
          setMessage("Ø®Ø·Ø£: ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù Ø§Ù„ØµÙˆØª Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù….");
        });
      }
      
      setMessage(`Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù‚Ø·Ø¹ (${isSlow ? 'Ø¨Ø·ÙŠØ¡' : 'Ø¹Ø§Ø¯ÙŠ'})... Ø±ÙƒØ² Ø¬ÙŠØ¯Ø§Ù‹!`);
    } catch (err) {
      console.error("Update Error:", err);
      setMessage("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    }
  };

  if (loading) return (
    <div className="flex h-screen items-center justify-center bg-slate-900 text-white text-2xl font-bold font-sans">
      Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-950 text-white font-sans p-4 flex flex-col items-center justify-center">
      <div className="max-w-md w-full bg-slate-900 rounded-3xl p-8 shadow-2xl border border-slate-800">
        <h1 className="text-3xl font-extrabold text-center mb-6 text-yellow-500">Superstars Dictation</h1>
        
        {!isRegistered ? (
          <div className="space-y-4">
            <p className="text-center text-slate-400">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</p>
            <input 
              type="text" 
              placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„"
              className="w-full p-4 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none focus:border-yellow-500 transition-all text-center text-white"
              value={studentName}
              onChange={(e) => setStudentName(e.target.value)}
            />
            <button 
              onClick={handleLogin}
              className="w-full py-4 bg-yellow-500 hover:bg-yellow-600 text-slate-950 font-bold rounded-xl transition-all shadow-lg active:scale-95"
            >
              Ø¯Ø®ÙˆÙ„
            </button>
          </div>
        ) : (
          <div className="space-y-8 text-center">
            <div className="bg-slate-800 p-4 rounded-2xl border border-slate-700">
              <p className="text-sm text-slate-400">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø¨Ø·Ù„</p>
              <p className="text-xl font-bold text-yellow-500 uppercase">{studentName}</p>
            </div>

            <div className="bg-red-900/20 border border-red-900/50 p-3 rounded-xl mb-4">
              <p className="text-xs text-red-400 font-bold uppercase">âš ï¸ Warning: Single Play Only</p>
            </div>

            <div className="space-y-6">
              <button 
                disabled={stats.slowHeard}
                onClick={() => playAudio('slow')}
                className={`w-full py-6 rounded-2xl flex items-center justify-center gap-3 font-bold text-lg transition-all ${
                  stats.slowHeard ? 'bg-slate-800 text-slate-500 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-900/40 shadow-xl'
                }`}
              >
                {stats.slowHeard ? 'Used (Slow)' : 'Play (Slow Motion)'}
                {!stats.slowHeard && <span className="text-2xl">ğŸ¢</span>}
              </button>

              <button 
                disabled={stats.normalHeard}
                onClick={() => playAudio('normal')}
                className={`w-full py-6 rounded-2xl flex items-center justify-center gap-3 font-bold text-lg transition-all ${
                  stats.normalHeard ? 'bg-slate-800 text-slate-500 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 shadow-green-900/40 shadow-xl'
                }`}
              >
                {stats.normalHeard ? 'Used (Normal)' : 'Play (Normal Speed)'}
                {!stats.normalHeard && <span className="text-2xl">âš¡</span>}
              </button>
            </div>

            {message && (
              <div className="p-4 bg-slate-800/50 rounded-xl text-yellow-200 text-sm animate-pulse border border-yellow-900/30">
                {message}
              </div>
            )}

            <audio ref={slowAudioRef} preload="auto">
              <source src={slowAudioUrl} type="audio/wav" />
            </audio>
            <audio ref={normalAudioRef} preload="auto">
              <source src={normalAudioUrl} type="audio/wav" />
            </audio>

            <p className="text-xs text-slate-500 pt-4 font-mono">ACTIVITY_ID: D X 1</p>
          </div>
        )}
      </div>
    </div>
  );
}
