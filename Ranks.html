/**
 * EYC Viens Management Script
 * Created for: Mr. EYC Academy
 */

const CONFIG = {
  SOURCE_ID: "1jqnXozGxe1vAlnSWo1dqJxHz1pjZGQIs2SuKwcYjbJw", // شيت التسجيل
  DATA_ID: "1qe_Kn2Rs6SVCHyacOGFXyFwUtQ5-2ElFynxm7hNOq7k",   // شيت الفينز الحالي
  TITLES: ["Greeny", "Junior", "Senior", "Master", "Legend", "Relentless"]
};

function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('EYC System')
    .addItem('Sync & Update All', 'mainSyncProcess')
    .addToUi();
}

function mainSyncProcess() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet1 = ss.getSheetByName("Sheet1") || ss.getSheets()[0];
  
  const sourceSS = SpreadsheetApp.openById(CONFIG.SOURCE_ID);
  const sourceSheet = sourceSS.getSheetByName("Form Responses 1");
  const sourceData = sourceSheet.getRange(2, 1, sourceSheet.getLastRow() - 1, 8).getValues(); // A to H
  
  // قراءة البيانات الحالية في الفينز
  const lastRow = sheet1.getLastRow();
  const currentNames = lastRow > 2 ? sheet1.getRange(3, 1, lastRow - 2, 1).getValues().flat() : [];
  
  sourceData.forEach((row) => {
    const email = row[1]; // Column B (Passcode)
    const name = row[3];  // Column D (Name)
    const xboxOpt = row[6]; // Column G (Xbox selection)
    const photo = row[7]; // Column H (Photo)
    
    let rowIndex = currentNames.indexOf(name);
    let targetRow;

    if (rowIndex === -1) {
      // عضو جديد
      targetRow = sheet1.getLastRow() + 1;
      sheet1.getRange(targetRow, 1).setValue(name); // A: Name
      sheet1.getRange(targetRow, 14).setValue(name); // N: Season Name
      
      if (String(xboxOpt).toLowerCase().includes("xbox")) {
        sheet1.getRange(targetRow, 28).setValue(name); // AB: Xbox Name
      }
    } else {
      targetRow = rowIndex + 3;
    }

    // تحديث البيانات الأساسية
    sheet1.getRange(targetRow, 2).setValue(email); // B: Passcode
    sheet1.getRange(targetRow, 7).setValue(photo); // G: Photo
  });

  calculateAllLogic(sheet1);
}

function calculateAllLogic(sheet) {
  const lastRow = sheet.getLastRow();
  if (lastRow < 3) return;

  const dataRange = sheet.getRange(3, 1, lastRow - 2, 35); // A to AI
  const values = dataRange.getValues();

  const updatedValues = values.map((row, index) => {
    // حساب توكينز السيزون (H to M) -> الأعمدة 7 إلى 12
    let seasonTokens = 0;
    for(let i=7; i<=12; i++) seasonTokens += Number(row[i]) || 0;
    row[14] = seasonTokens; // O: Season Total

    // حساب توكينز الإكس بوكس (R to AA) -> الأعمدة 17 إلى 26
    let xboxTokens = 0;
    for(let i=17; i<=26; i++) xboxTokens += Number(row[i]) || 0;
    row[28] = xboxTokens; // AC: Xbox Total

    // الماستر شيت (C): مجموع O و AC
    const totalMaster = seasonTokens + xboxTokens;
    row[2] = totalMaster; // C: Master Tokens

    // النجوم (D): توتال / 50
    const stars = totalMaster / 50;
    row[3] = stars; // D: Stars

    // ألقاب السيزون (Q) -> كل 50 توكينز
    row[16] = getTitleByStep(seasonTokens, 50);

    // ألقاب الإكس بوكس (AE) -> كل 100 توكينز
    row[30] = getTitleByStep(xboxTokens, 100);

    // ألقاب الماستر (F) -> كل 5 نجوم
    row[5] = getTitleByStep(stars, 5);

    return row;
  });

  dataRange.setValues(updatedValues);
  
  // تحديث الرانك (الترتيب)
  updateRankingValues(sheet, lastRow);
}

function getTitleByStep(value, step) {
  let index = Math.floor(value / step);
  if (value > 0 && index === 0) index = 0; // البداية Greeny بمجرد كسب أي شيء
  if (index >= CONFIG.TITLES.length) index = CONFIG.TITLES.length - 1;
  return CONFIG.TITLES[index] || CONFIG.TITLES[0];
}

function updateRankingValues(sheet, lastRow) {
  // رانك الماستر (العمود E بناء على C) مع تحريك الصفوف
  const fullRange = sheet.getRange(3, 1, lastRow - 2, 35);
  fullRange.sort({column: 3, ascending: false});
  
  const newValues = sheet.getRange(3, 1, lastRow - 2, 35).getValues();
  
  // تحديث أرقام الرانك المكتوبة
  const updatedRanks = newValues.map((row, idx) => {
     row[4] = idx + 1; // E: Master Rank
     return row;
  });
  sheet.getRange(3, 1, lastRow - 2, 35).setValues(updatedRanks);

  // رانك السيزون (العمود P بناء على O) - بدون تحريك صفوف
  const seasonTokens = sheet.getRange(3, 15, lastRow - 2, 1).getValues().flat();
  const sortedSeason = [...seasonTokens].sort((a,b) => b-a);
  const pRanks = seasonTokens.map(v => sortedSeason.indexOf(v) + 1);
  sheet.getRange(3, 16, lastRow - 2, 1).setValues(pRanks.map(r => [r]));
  
  // رانك الإكس بوكس (العمود AD بناء على AC) - بدون تحريك صفوف
  const xboxTokens = sheet.getRange(3, 29, lastRow - 2, 1).getValues().flat();
  const sortedXbox = [...xboxTokens].sort((a,b) => b-a);
  const adRanks = xboxTokens.map(v => sortedXbox.indexOf(v) + 1);
  sheet.getRange(3, 30, lastRow - 2, 1).setValues(adRanks.map(r => [r]));
}
