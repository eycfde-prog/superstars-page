<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EYC - Hybrid-X Mission Area</title>
    <?!= include('mcstyle'); ?> <style>
        .x-container { border: 3px solid var(--gold); box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); }
        #mission-frame-x { width: 100%; height: 85vh; border: none; background: #000; border-radius: 10px; }
        .level-indicator { background: var(--gold); color: #000; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="main-container x-container">
    <div class="mission-header">
        <button onclick="window.location.href='?page=MC'" class="prev-btn">◀ Return to Base</button>
        <div style="text-align: center;">
            <h2 id="mission-title-x">LOADING ROYAL MISSION...</h2>
            <span class="level-indicator" id="level-display">LEVEL: ANALYZING...</span>
        </div>
        <div id="agent-display-x" style="color: var(--gold);">AGENT: ...</div>
    </div>

    <iframe id="mission-frame-x" src="" frameborder="0" allow="camera; microphone"></iframe>

    <div id="status-update-x" style="text-align: center; margin-top: 10px; color: #d4af37; display: none; font-family: 'Courier New', monospace;">
        >> SECURE DATA TRANSMISSION IN PROGRESS...
    </div>
</div>

<script>
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const missionURL = urlParams.get('missionURL');
        
        const agentName = localStorage.getItem('agentName') || "Royal Agent";
        document.getElementById('agent-display-x').innerText = "AGENT: " + agentName;

        if (missionURL) {
            document.getElementById('mission-frame-x').src = missionURL;
            const missionCode = missionURL.split('/').pop().replace('.html', '');
            document.getElementById('mission-title-x').innerText = "ROYAL MISSION: " + missionCode;
            
            // تحديد المستوى تلقائياً بناءً على كود المهمة في نظام X
            determineLevel(missionCode);
        } else {
            alert("Mission URL Missing, Agent!");
            window.location.href = '?page=MC';
        }
    };

    function determineLevel(code) {
        // منطق تحديد المستويات للـ HybridX (مثلاً 1-3 سهل، 4-7 متوسط، 8-10 محترف)
        const num = parseInt(code.replace(/\D/g, ''));
        let level = "ADVANCED";
        if (num <= 3) level = "BASIC";
        else if (num <= 7) level = "INTERMEDIATE";
        document.getElementById('level-display').innerText = "LEVEL: " + level;
    }

    // استقبال التقارير من ملفات الـ JS (مجلد CC) عبر الـ Iframe
    window.addEventListener('message', function(event) {
        const report = event.data;
        if (report && report.type === 'SUBMIT_X') {
            sendReportToBackend(report);
        }
    });

    function sendReportToBackend(report) {
        document.getElementById('status-update-x').style.display = 'block';
        
        // إرسال البيانات للـ Apps Script ليقوم بفلترة الدرجة (1- 5) وحفظها
        google.script.run
            .withSuccessHandler(function() {
                alert("Royal Data Synced Successfully!");
                window.location.href = '?page=MC';
            })
            .withFailureHandler(function(err) {
                alert("Sync Error: " + err);
                document.getElementById('status-update-x').style.display = 'none';
            })
            .submitMissionReport(report);
    }
</script>

</body>
</html>
