/**
 * نظام EYC المتكامل - شييت Vens
 * المطور: Glassy (EYC Team)
 */

const SIGNUP_SHEET_ID = "1_tfsbzCRDQXmibM3hLnYCFx98s2vzEPg8PI8cmMUE6s"; 

// 1. استقبال طلبات الموقع (تسجيل الدخول وجلب البيانات)
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("Vens");
    
    if (data.action === "login") {
      const email = data.email.toLowerCase().trim();
      const studentCode = data.password.trim(); 
      const rows = sheet.getDataRange().getValues();
      
      for (let i = 1; i < rows.length; i++) {
        // التحقق من الإيميل (العمود C/رقم 2) والكود (العمود F/رقم 5)
        if (rows[i][2].toString().toLowerCase().trim() === email && rows[i][5].toString() === studentCode) {
          
          // وضع علامة صح في العمود X (رقم 23) لتسجيل الحضور
          sheet.getRange(i + 1, 24).setValue(true);
          
          // إرجاع البيانات المطلوبة للصفحة
          return ContentService.createTextOutput(JSON.stringify({
            "status": "success",
            "name": rows[i][0],      // العمود A
            "image": rows[i][4],     // العمود E (لينك الدرايف)
            "tokens": rows[i][22],   // العمود W
            "rank": i                // الترتيب الحالي بناءً على الصف
          })).setMimeType(ContentService.MimeType.JSON);
        }
      }
      return ContentService.createTextOutput(JSON.stringify({ "status": "error", "message": "Wrong Email or Code" }))
        .setMimeType(ContentService.MimeType.JSON);
    }
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ "result": "error", "error": err.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// 2. وظيفة المزامنة مع شييت الساين اب (لا تتأثر)
function syncAndProcessStudents() {
  const ssVens = SpreadsheetApp.getActiveSpreadsheet();
  const vensSheet = ssVens.getSheetByName("Vens");
  
  let ssSignUp;
  try { ssSignUp = SpreadsheetApp.openById(SIGNUP_SHEET_ID); } catch (e) { return; }

  const signUpSheet = ssSignUp.getSheetByName("players") || ssSignUp.getSheetByName("Sign-Up (Responses)");
  const students = signUpSheet.getDataRange().getValues().slice(1); 
  
  let vensData = vensSheet.getDataRange().getValues();
  let existingEmails = vensData.map(row => row[2] ? row[2].toString().toLowerCase().trim() : ""); 

  students.forEach((student) => {
    let email = student[3] ? student[3].toString().toLowerCase().trim() : ""; 
    if (email && existingEmails.indexOf(email) === -1) {
      let studentCode = generateStudentCode(student[1]);
      let newRow = [
        student[1], // A الاسم
        student[2], // B السن
        student[3], // C الإيميل
        student[4], // D البرامج
        student[5], // E الصورة
        studentCode, // F الكود
      ];
      for (let i = 0; i < 16; i++) { newRow.push(0); } // G to V
      vensSheet.appendRow(newRow);
    }
  });
  refreshCalculations();
}

function generateStudentCode(name) {
  let parts = name.trim().split(" ");
  let firstLetter = parts[0] ? parts[0].charAt(0).toUpperCase() : "E";
  let secondLetter = parts[1] ? parts[1].charAt(0).toUpperCase() : "Y";
  return firstLetter + secondLetter + "EYCSS" + Math.floor(1000 + Math.random() * 9000);
}

function refreshCalculations() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Vens");
  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return;
  const range = sheet.getRange(2, 1, lastRow - 1, 27);
  const data = range.getValues();

  data.forEach((row) => {
    let totalTokens = 0;
    for (let j = 6; j <= 21; j++) { totalTokens += Number(row[j] || 0); }
    row[22] = totalTokens; // W
    let stars = totalTokens / 100;
    row[24] = stars; // Y
    row[25] = Math.floor(stars / 5); // Z
    row[26] = getStudentTitle(totalTokens); // AA
  });

  range.setValues(data);
  sheet.getRange(2, 1, lastRow - 1, 27).sort({column: 23, ascending: false});
}

function getStudentTitle(tokens) {
  if (tokens >= 5000) return "EYC MASTER";
  if (tokens >= 3000) return "EYC PROFISSIONAL";
  if (tokens >= 2000) return "EYC SPECIALIST";
  if (tokens >= 1000) return "EYC AGENT";
  if (tokens >= 750)  return "EYC ADVANCED";
  if (tokens >= 500)  return "EYC SSS";
  if (tokens >= 300)  return "EYC SS";
  if (tokens >= 150)  return "EYC S";
  if (tokens >= 50)   return "EYC BEGINNER";
  return "Greeny";
}

function dailyResetAttendance() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Vens");
  const lastRow = sheet.getLastRow();
  if (lastRow > 1) { sheet.getRange(2, 24, lastRow - 1, 1).setValue(false); }
}
