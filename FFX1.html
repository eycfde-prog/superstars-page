<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Figurative Focus X</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold-primary: #d4af37;
            --gold-light: #f1c40f;
            --gold-dark: #996515;
            --bg-black: #0a0a0a;
        }

        body {
            background-color: var(--bg-black);
            color: #e0e0e0;
            font-family: 'Montserrat', sans-serif;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(212, 175, 55, 0.05) 0%, transparent 20%);
            min-height: 100vh;
        }

        .cinzel { font-family: 'Cinzel', serif; }
        .gold-text-gradient {
            background: linear-gradient(to bottom, #fff7ad 0%, #d4af37 50%, #996515 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .border-gold { border: 1px solid rgba(212, 175, 55, 0.4); }
        .gold-gradient-bg { background: linear-gradient(135deg, var(--gold-dark), var(--gold-primary), var(--gold-light)); }

        /* Login Section Styles */
        #loginSection {
            backdrop-filter: blur(10px);
            background: rgba(20, 20, 20, 0.8);
        }

        .input-gold {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: white;
            transition: all 0.4s;
        }

        .input-gold:focus {
            border-color: var(--gold-light);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
            outline: none;
        }

        .btn-gold {
            background: linear-gradient(135deg, var(--gold-dark) 0%, var(--gold-primary) 50%, var(--gold-light) 100%);
            color: black;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
        }

        .btn-gold:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
        }

        .btn-gold:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Dialogue Styles */
        .dialogue-container { position: relative; padding-left: 20px; }
        .dialogue-container::before {
            content: '';
            position: absolute; left: 0; top: 0; bottom: 0; width: 2px;
            background: linear-gradient(to bottom, transparent, var(--gold-primary), transparent);
        }

        .speech-card {
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .speech-card:hover {
            background: rgba(212, 175, 55, 0.05);
            border-left: 3px solid var(--gold-primary);
            transform: translateX(10px);
        }

        .speaker-label {
            font-size: 0.7rem;
            letter-spacing: 2px;
            color: var(--gold-primary);
            text-transform: uppercase;
            font-weight: 900;
        }

        .figurative-box {
            background: rgba(212, 175, 55, 0.1);
            border: 2px dashed var(--gold-primary);
        }

        .hidden-section { display: none; }
    </style>
</head>
<body class="flex flex-col items-center py-10 px-4">

    <!-- Header -->
    <header class="text-center mb-12">
        <h1 class="cinzel text-4xl md:text-6xl font-black gold-text-gradient mb-2">FIGURATIVE FOCUS X</h1>
        <p class="text-gray-500 tracking-[0.3em] uppercase text-xs font-bold">Unmask the Literal - Reveal the Figurative</p>
        <div class="w-32 h-1 gold-gradient-bg mx-auto mt-4"></div>
    </header>

    <!-- 1. Login Section -->
    <div id="loginSection" class="w-full max-w-md p-8 rounded-3xl border-gold text-center mb-10">
        <h2 class="cinzel text-gold-primary text-xl mb-6">IDENTIFICATION REQUIRED</h2>
        <input type="text" id="emailInput" class="input-gold w-full py-4 px-6 rounded-xl mb-4 text-center" placeholder="Enter Email or Student Code">
        <div id="errorMessage" class="mb-4 text-red-500 text-xs font-bold hidden bg-red-900/10 p-2 border border-red-500/20 rounded"></div>
        <button onclick="handleLogin()" id="loginBtn" class="btn-gold w-full py-4 rounded-xl">Initialize Session</button>
    </div>

    <!-- 2. Main Activity Section (Hidden Initially) -->
    <main id="activitySection" class="w-full max-w-3xl hidden-section">
        
        <!-- Welcome User Info -->
        <div class="p-4 rounded-xl border-gold mb-8 flex justify-between items-center bg-white/5">
            <div>
                <p class="text-gray-500 text-[10px] uppercase tracking-widest">Authorized Student</p>
                <p id="displayEmail" class="text-gold-primary font-bold">---</p>
            </div>
            <div class="text-right">
                <p class="text-gray-500 text-[10px] uppercase tracking-widest">Access Status</p>
                <p class="text-green-500 font-bold uppercase text-xs">Verified</p>
            </div>
        </div>

        <!-- Dialogue Section -->
        <section class="mb-10">
            <h2 class="cinzel text-gold-primary text-xl mb-6 flex items-center gap-3">
                <span class="w-8 h-[1px] bg-gold-primary"></span>
                The Dialogue Exchange
            </h2>
            <div class="dialogue-container space-y-4">
                <div class="speech-card p-4 rounded-lg">
                    <p class="speaker-label mb-1">Speaker A</p>
                    <p class="text-lg italic">"I’m so nervous about the final presentation tomorrow; I feel like I might forget everything I practiced."</p>
                </div>
            <div class="dialogue-container space-y-4">
                <div class="speech-card p-4 rounded-lg">
                    <p class="speaker-label mb-1">Speaker B</p>
                    <p class="text-lg italic">"Don't worry, you've worked harder than anyone else. Just go out there and break a leg!"</p>
                </div>
            <div class="dialogue-container space-y-4">
                <div class="speech-card p-4 rounded-lg">
                    <p class="speaker-label mb-1">Speaker A</p>
                    <p class="text-lg italic">"I hope you're right, but what if the judges ask me something I don't know"</p>
                </div>
                <div class="speech-card p-4 rounded-lg">
                    <p class="speaker-label mb-1">Speaker B</p>
                    <p class="text-lg italic">"Then just be honest and stay calm; you’ll do great, I promise."</p>
                </div>
            </div>
        </section>

        <!-- Focus Phrase -->
        <section class="mb-10">
            <div class="figurative-box p-6 rounded-2xl text-center">
                <h3 class="cinzel text-xs text-gold-primary tracking-widest mb-2 font-bold uppercase">The Targeted Phrase</h3>
                <p class="text-2xl md:text-3xl font-bold gold-text-gradient italic">"break a leg!"</p>
            </div>
        </section>

        <!-- Submission Box -->
        <section class="bg-[#111] p-8 rounded-3xl border-gold shadow-2xl relative overflow-hidden">
            <h3 class="cinzel text-lg text-white mb-4">Final Interpretation</h3>
            <p class="text-sm text-gray-400 mb-4 font-semibold">Based on the context, what does "hit the sack" mean?</p>
            <textarea id="studentResponse" class="input-gold w-full h-32 p-4 rounded-xl mb-6" placeholder="Write your analysis here..."></textarea>
            <button onclick="submitAnswer()" id="submitBtn" class="btn-gold w-full py-5 rounded-xl text-lg flex items-center justify-center gap-2">
                <span>SUBMIT ANALYSIS</span>
            </button>
            <p id="statusMsg" class="text-center mt-4 text-sm font-bold uppercase tracking-widest"></p>
        </section>
    </main>

    <footer class="mt-20 text-gray-600 text-[10px] cinzel tracking-[0.5em]">
        Proprietary Content of Figurative Focus X - 2026
    </footer>

    <script>
        // الرابط الجديد الذي قمت بعمله (Deploy URL)
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwjMPJD-ZVrstF_5a_Kf53EEz3cp2USbhHgiK3gUMX1DvIBjJdlqB3nTTzKihq1NCXJ/exec";
        let currentUserKey = "";

        async function handleLogin() {
            const input = document.getElementById('emailInput').value.trim();
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('errorMessage');
            
            if (input.length < 3) {
                showError("INPUT TOO SHORT");
                return;
            }

            btn.disabled = true;
            btn.innerText = "VERIFYING...";
            err.classList.add('hidden');

            try {
                // استدعاء الأكشن check من السكريبت
                const response = await fetch(`${APPS_SCRIPT_URL}?action=check&email=${encodeURIComponent(input)}`);
                const data = await response.json();

                if (data.status === "authorized") {
                    currentUserKey = data.email || input;
                    document.getElementById('displayEmail').innerText = currentUserKey;
                    
                    document.getElementById('loginSection').classList.add('hidden-section');
                    document.getElementById('activitySection').classList.remove('hidden-section');
                } else if (data.status === "already_done") {
                    showError("TASK ALREADY COMPLETED");
                } else {
                    showError("ACCESS DENIED: NOT FOUND");
                }
            } catch (e) {
                showError("CONNECTION ERROR");
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.innerText = "Initialize Session";
            }
        }

        async function submitAnswer() {
            const response = document.getElementById('studentResponse').value.trim();
            const submitBtn = document.getElementById('submitBtn');
            const statusMsg = document.getElementById('statusMsg');

            if (!response) {
                alert("Please write your interpretation.");
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerText = "TRANSMITTING...";
            statusMsg.innerText = "Saving to database...";
            statusMsg.className = "text-center mt-4 text-sm font-bold uppercase tracking-widest text-gold-primary";

            try {
                // إرسال الإجابة لتعلق بالعمود C
                const finalUrl = `${APPS_SCRIPT_URL}?action=submit_answer&userKey=${encodeURIComponent(currentUserKey)}&answer=${encodeURIComponent(response)}`;
                
                // استخدام mode no-cors لتجنب مشاكل Redirect في جوجل
                await fetch(finalUrl, { method: 'GET', mode: 'no-cors' });

                statusMsg.innerText = "ANALYSIS RECORDED SUCCESSFULLY";
                statusMsg.className = "text-center mt-4 text-sm font-bold uppercase tracking-widest text-green-500";
                
                document.getElementById('studentResponse').disabled = true;
                submitBtn.innerText = "COMPLETED";
            } catch (e) {
                statusMsg.innerText = "TRANSMISSION FAILED";
                statusMsg.className = "text-center mt-4 text-sm font-bold uppercase tracking-widest text-red-500";
                submitBtn.disabled = false;
                submitBtn.innerText = "RETRY SUBMISSION";
            }
        }

        function showError(m) {
            const e = document.getElementById('errorMessage');
            e.innerText = m;
            e.classList.remove('hidden');
        }

        // منع إغلاق الصفحة بالخطأ
        window.onbeforeunload = () => currentUserKey ? "Don't lose your progress!" : null;
    </script>
</body>
</html>



