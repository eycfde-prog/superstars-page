/**
 * EYC Scoring System - Centralized Answers Hub
 * Developed for: Mr. EYC
 * محرك استقبال الإجابات وتوزيعها مع دعم صفحة Alike وشيت Sign-Up (Responses)
 */

// --- CONFIGURATION ---
const SIGNUP_SHEET_ID = "1pu6qPbnvrygZiXfjP2QFp_gpLIHaPE4M67e0eYttdwQ";
const MASTER_SIGNUP_TAB = "Sign-Up (Responses)"; 
const SCORE_SHEET_NAME = "Score";

// خريطة الربط بين اسم الصفحة واسم النشاط في الشيت
const ACTIVITY_MAP = {
  "seeds.html": "Seeds",
  "GoldenEar.htmlde": "Golden ear",
  "Grammar.htmlde": "Grammar",
  "Label.htmlgl": "Label",
  "Vivid.html": "Vivid",
  "SeedsX.html": "Seedsx",
  "GEX.html": "Golden earx",
  "GX.html": "Grammarx",
  "Labelx.html": "Labelx",
  "Vividx.html": "Vividx",
  "AlikeXIndex.html": "Alikex",
  "SSS.html": "Sssx",
  "FFX.html": "Figurativex",
  "Dictationx.html": "Dictationx",
  "Elmagazinex.html": "Elmagazinex",
  "Alike.html": "Alike" // النشاط الجديد
};

// قائمة الأنشطة بالترتيب لنسخها في العمود B
const ACTIVITIES_LIST = [
  "Seeds", "Golden ear", "Grammar", "Label", "Vivid",
  "Seedsx", "Golden earx", "Grammarx", "Labelx", "Vividx",
  "Alikex", "Sssx", "Figurativex", "Dictationx", "Elmagazinex",
  "Alike"
];

function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    const identifier = params.studentId; 
    const pageName = params.pageName;    
    const score = params.score;          
    
    const activityName = ACTIVITY_MAP[pageName];
    if (!activityName) {
      return ContentService.createTextOutput(JSON.stringify({"status": "error", "message": "Activity not mapped"})).setMimeType(ContentService.MimeType.JSON);
    }
    const result = processSubmission(identifier, activityName, score);
    return ContentService.createTextOutput(JSON.stringify({"status": "success", "result": result})).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({"status": "error", "message": err.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}

function processSubmission(identifier, activityName, studentAnswer) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const scoreSheet = ss.getSheetByName(SCORE_SHEET_NAME);
  const studentInfo = getStudentInfoFromMaster(identifier);
  if (!studentInfo) return "Student not found";
  const studentFullName = studentInfo.name;

  let studentColumn = findStudentColumn(scoreSheet, studentFullName);
  if (studentColumn === -1) {
    studentColumn = scoreSheet.getLastColumn() + 1;
    scoreSheet.getRange(1, studentColumn).setValue(studentFullName)
      .setBackground("#fcc200").setFontWeight("bold");
  }

  const activityRow = ACTIVITIES_LIST.indexOf(activityName) + 2;
  const cell = scoreSheet.getRange(activityRow, studentColumn);
  const currentValue = cell.getValue().toString();
  
  let newValue = "";
  if (!currentValue || currentValue.trim() === "") {
    newValue = "1) " + studentAnswer;
  } else {
    const attempts = (currentValue.match(/\d+\)/g) || []).length;
    newValue = currentValue + "\n" + (attempts + 1) + ") " + studentAnswer;
  }
  cell.setValue(newValue);
  scoreSheet.getRange(scoreSheet.getLastRow() + 1, 1).setValue(identifier + " | " + activityName + " | " + new Date().toLocaleString());
  return "Updated column " + studentColumn;
}

function getStudentInfoFromMaster(id) {
  const masterSS = SpreadsheetApp.openById(SIGNUP_SHEET_ID);
  const sheet = masterSS.getSheetByName(MASTER_SIGNUP_TAB);
  if (!sheet) return null;
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (id == data[i][1] || id == data[i][8]) return { name: data[i][3] };
  }
  return null;
}

function findStudentColumn(sheet, name) {
  const lastCol = sheet.getLastColumn();
  if (lastCol < 2) return -1;
  const headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
  for (let j = 2; j < headers.length; j++) { if (headers[j] === name) return j + 1; }
  return -1;
}
