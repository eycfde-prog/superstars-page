/**
 * FX.js - محرك تصحيح FigurativeX
 * تصميم: جي (Ge) لمستر عز
 */

function gradeMission(data) {
    const studentAnswers = data.answers; // مصفوفة من 5 إجابات بالعربي
    const taskNum = data.missionNum;

    // قاعدة بيانات الإجابات (مطابقة لما في صفحة الـ HTML)
    const figurativeModel = {
        "1": [
            ["هل تحتاج مساعدة", "محتاج مساعدة", "تحتاج مساعدة", "عايز مساعدة", "محتاج ايد مساعدة"],
            ["ينهي العمل اليوم", "يكتفي بهذا القدر اليوم", "كفاية كدة النهاردة", "يوقف شغل", "نكتفي كدة"],
            ["ارفع رأسك", "لا تحزن", "خليك متفائل", "خلي معنوياتك عالية", "متزعلش"],
            ["اسرع", "عجل", "هز رجلك", "يلا بسرعة", "اتحرك بسرعة", "انجز"],
            ["توتر", "اشعر بالتوتر", "قلق", "عندي مغص من التوتر", "رفرفة في معدتي"]
        ],
        "2": [
            ["تجنب المشاكل", "لا تنبش في الماضي", "سيب المشاكل نايمة", "بلاش تفتح مواضيع قديمة", "ابعد عن المشاكل"],
            ["فجأة", "بدون سابق انذار", "من حيث لا ندري", "علي غفلة", "فجأة كدة"],
            ["مريض", "تعبان", "حاسس اني مش تمام", "صحتك مش كويسة", "وعكة صحية"],
            ["سهل جدا", "تافه", "زي السكينة في الحلاوة", "بسيط جدا", "لعبة عيال"],
            ["أصبت الهدف", "جبت الخلاصة", "جبت من الآخر", "قلت القول الفصل", "وصف دقيق"]
        ],
        "3": [
            ["نفكر في الموضوع", "نأجل القرار للصبح", "ناخد وقتنا في التفكير", "ننام ونفكر", "نقرر بكرة"],
            ["تمزح معي", "تضحك علي", "بتشتغلني", "بتهزر معايا", "بتسرح بيا"],
            ["خفت", "ترددت", "رجلي سقعت", "تراجعت من الخوف", "جالي رعب"],
            ["اتفقنا", "وجهات نظرنا متطابقة", "كنا على نفس الخط", "متفقين تماما", "فهمنا بعض"],
            ["القشة التي قصمت ظهر البعير", "آخر صبري", "خلاص كدة جابت اخرها", "القشة الاخيرة", "كفاية كدة"]
        ],
        "4": [
            ["اصمد", "اصبر", "استمر", "خليك صامد", "متستسلمش"],
            ["في نفس الموقف", "في الهوا سوا", "في مركب واحدة", "حالنا واحد", "زي بعض"],
            ["يفشي السر", "يقول اللي عنده", "يبق البحصة", "يقول السر", "يفت الفتات"],
            ["غالي جدا", "ثمنه باهظ", "كلفني الشيء الفلاني", "غالي نار", "كلفني ذراع ورجل"],
            ["على طرف لساني", "هفتكره حالا", "عارفه بس مش فاكره", "كلمة على لساني"]
        ],
        "5": [
            ["يتفاخر", "بيتباهى بنفسه", "بيطبل لنفسه", "بيفشر", "بيحب المنظرة"],
            ["بالتوفيق", "حظ سعيد", "اكسر رجل", "وريهم شطارتك", "أتمنى لك النجاح"],
            ["جرحني بشدة", "جاءت على الجرح", "وجعني قوي", "آلمني", "أصابني في مقتل"],
            ["حملت نفسك فوق طاقتك", "اخذت خازوق", "طمعت في اكتر من طاقتك", "فتحت صدرك على الفاضي"],
            ["روح المكان", "شخصية مرحة", "فاكهة القعدة", "محرك الحفلة", "شخص اجتماعي جدا"]
        ]
    };

    const currentModel = figurativeModel[taskNum] || [];
    let score = 0;

    studentAnswers.forEach((ans, index) => {
        if (!ans) return;

        // تنظيف إجابة الطالب (إزالة الهمزات، توحيد الياء والهاء) لمرونة المطابقة
        const cleanAns = normalizeArabic(ans);
        const possibleAnswers = currentModel[index] || [];

        // فحص ما إذا كانت إجابة الطالب مطابقة لأي من الخيارات المتاحة
        const isCorrect = possibleAnswers.some(modelAns => normalizeArabic(modelAns) === cleanAns);

        if (isCorrect) {
            score += 1;
        }
    });

    // تطبيق مبدأ مستر عز: الحد الأدنى 1 درجة (إذا شارك الطالب بكلمة واحدة على الأقل)
    const hasParticipated = studentAnswers.some(a => a.trim().length > 0);
    let finalScore = score;
    
    if (hasParticipated && finalScore < 1) {
        finalScore = 1;
    }

    return Math.min(5, finalScore);
}

/**
 * دالة توحيد النص العربي لضمان العدل في التصحيح
 * (تحويل أ إ آ إلى ا، والـ ى إلى ي، والـ ة إلى هـ)
 */
function normalizeArabic(text) {
    return text.trim()
        .replace(/[إأآ]/g, "ا")
        .replace(/ى/g, "ي")
        .replace(/ة/g, "ه")
        .replace(/\s+/g, " "); // إزالة المسافات الزائدة
}
